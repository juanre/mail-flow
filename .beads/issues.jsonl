{"id":"docs-1","title":"Personal unified archive (filesystem + llmemory) v1","description":"North star: personal unified archive on local filesystem (~/Archive) written via docflow-archive (archive protocol); classification via llm-archivist (LLM arbiter + vector KNN fast path); search/index via llmemory. This epic tracks the coordinated work to reach a no-user-prompting end state, with an interactive validation mode during development.","design":"Coordinator epic: keep SOT descriptive only; all implementation steps live in child beads. No backwards compatibility; remove legacy knobs rather than shims.","acceptance_criteria":"All core repos implement the end-state described in docflow-sot/source-of-truth/: docflow-archive defines the on-disk contract; mail connector archives to ~/Archive; llm-archivist classifies with LLM arbiter + vector KNN fast path; llmemory is the primary search layer; non-interactive mode runs with zero prompts; interactive mode supports confirm/correct feedback.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-01-01T18:57:11.762357Z","created_by":"juanre","updated_at":"2026-01-02T13:19:08.056471Z","dependencies":[{"issue_id":"docs-1","depends_on_id":"docs-2","type":"blocks","created_at":"2026-01-01T20:31:28.972844Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-3","type":"blocks","created_at":"2026-01-01T20:31:28.973417Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-4","type":"blocks","created_at":"2026-01-01T20:31:28.97392Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-5","type":"blocks","created_at":"2026-01-01T20:31:28.974396Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-6","type":"blocks","created_at":"2026-01-01T20:31:28.97488Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-7","type":"blocks","created_at":"2026-01-01T20:31:28.975341Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-8","type":"blocks","created_at":"2026-01-01T20:31:28.975799Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-9","type":"blocks","created_at":"2026-01-01T20:31:28.976274Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-10","type":"blocks","created_at":"2026-01-01T20:31:28.976737Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-11","type":"blocks","created_at":"2026-01-01T20:31:28.977202Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-12","type":"blocks","created_at":"2026-01-01T20:31:28.977652Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-13","type":"blocks","created_at":"2026-01-01T20:31:28.978103Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-14","type":"blocks","created_at":"2026-01-01T20:31:28.97856Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-15","type":"blocks","created_at":"2026-01-01T20:31:28.979011Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-16","type":"blocks","created_at":"2026-01-01T20:31:28.979461Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-17","type":"blocks","created_at":"2026-01-01T20:31:28.979901Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-18","type":"blocks","created_at":"2026-01-01T20:31:28.980341Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-19","type":"blocks","created_at":"2026-01-01T22:24:18.426614Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-21","type":"blocks","created_at":"2026-01-01T23:36:33.388921Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-22","type":"blocks","created_at":"2026-01-01T23:36:33.389576Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-23","type":"blocks","created_at":"2026-01-01T23:36:33.390105Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-24","type":"blocks","created_at":"2026-01-01T23:36:33.390612Z","created_by":"import"},{"issue_id":"docs-1","depends_on_id":"docs-25","type":"blocks","created_at":"2026-01-02T16:23:06.820537Z","created_by":"juanre"},{"issue_id":"docs-1","depends_on_id":"docs-28","type":"blocks","created_at":"2026-01-02T16:25:42.656813Z","created_by":"juanre"}]}
{"id":"docs-10","title":"mailflow: interactive validation vs non-interactive LLM arbiter","description":"Implement interactive vs non-interactive operation in mailflow:\n- Non-interactive: accept llm-archivist decision automatically (LLM is arbiter), no prompting.\n- Interactive: user confirms/corrects the proposed decision; feedback is recorded in llm-archivist.","design":"- Expose a single, explicit CLI switch (e.g., --interactive / --non-interactive) with a clear default.\n- Interactive mode UX:\n  - show proposed label/null, evidence (rationale / top neighbors / similarity), and allow confirm/correct.\n  - on correction, send feedback to llm-archivist referencing the decision/document.\n- Non-interactive mode:\n  - run with zero prompts.\n  - persist the decision and embedding normally.","acceptance_criteria":"- Running non-interactive produces zero prompts and still archives + records decisions.\n- Running interactive prompts exactly for decision validation and writes feedback on confirm/correct.\n- A test (or reproducible harness) demonstrates that interactive corrections affect later classifications (via llm-archivist feedback).","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-01T18:58:53.310992Z","created_by":"juanre","updated_at":"2026-01-02T13:48:53.627511Z","closed_at":"2026-01-02T13:48:53.627511Z","close_reason":"All completed in charlie/mailflow-docs-10 branch. 181 tests passing. Legacy knobs (auto_threshold, min_confidence, trust_llm, train_only, replay) and file_classifier integration removed. Interactive mode implemented via --interactive flag.","dependencies":[{"issue_id":"docs-10","depends_on_id":"docs-9","type":"blocks","created_at":"2026-01-01T20:31:28.98082Z","created_by":"import"},{"issue_id":"docs-10","depends_on_id":"docs-22","type":"blocks","created_at":"2026-01-01T23:36:33.391137Z","created_by":"import"}]}
{"id":"docs-11","title":"mailflow: remove legacy confidence knobs/flags (no backwards compatibility)","description":"Remove mailflow’s legacy confidence/threshold knobs (no backwards compatibility). After llm-archivist-only classification, mailflow should not implement separate confidence gating.","design":"- Delete ALL legacy confidence/training/gating knobs and modes (no backwards compatibility): auto_threshold, min_confidence, trust_llm, similarity_threshold, train-only, replay, and any prompts/auto-accept logic tied to these.\\n- mailflow should not attempt to interpret LLM confidence; LLM output is binary.\\n- mailflow should not prompt in non-interactive mode (including cost warnings).\\n- If configuration is needed, surface only:\\n  - archivist.similarity_threshold (from ~/.config/docflow/config.toml; forwarded to llm-archivist), and\\n  - interactive vs non-interactive mode.","acceptance_criteria":"- mailflow --help and docs mention none of the removed flags/modes.\\n- Non-interactive runs produce zero prompts (no cost confirmations).\\n- ripgrep finds zero references in mailflow/src to: auto_threshold|min_confidence|trust_llm|train_only|replay|similarity_threshold.\\n- Tests updated/passing.","status":"closed","priority":1,"issue_type":"chore","created_at":"2026-01-01T18:58:59.792406Z","created_by":"juanre","updated_at":"2026-01-02T13:48:53.628376Z","closed_at":"2026-01-02T13:48:53.628376Z","close_reason":"All completed in charlie/mailflow-docs-10 branch. 181 tests passing. Legacy knobs (auto_threshold, min_confidence, trust_llm, train_only, replay) and file_classifier integration removed. Interactive mode implemented via --interactive flag.","dependencies":[{"issue_id":"docs-11","depends_on_id":"docs-9","type":"blocks","created_at":"2026-01-01T20:31:28.981289Z","created_by":"import"}]}
{"id":"docs-12","title":"mailflow: remove file-classifier-core training/gate","description":"Remove file-classifier-core training/gating paths from mailflow so llm-archivist is the single workflow classifier.","design":"- Remove all usage of file-classifier-core (should_archive_email gate, classifier.json artifacts, get_classifier_suggestion, and any workflow gating).\\n- Classification is ONLY llm-archivist (vector KNN fast path + LLM arbiter).\\n- Delete the associated config keys (classifier.gate_enabled, gate_min_confidence, etc.) and code paths.","acceptance_criteria":"- ripgrep finds zero references in mailflow/src to: file_classifier|should_archive_email|classifier.json|gate_min_confidence|get_classifier_suggestion.\\n- mailflow can run classification without any local classifier artifacts.\\n- Tests updated/passing.","status":"closed","priority":1,"issue_type":"chore","created_at":"2026-01-01T18:59:06.381875Z","created_by":"juanre","updated_at":"2026-01-02T13:48:53.628998Z","closed_at":"2026-01-02T13:48:53.628998Z","close_reason":"All completed in charlie/mailflow-docs-10 branch. 181 tests passing. Legacy knobs (auto_threshold, min_confidence, trust_llm, train_only, replay) and file_classifier integration removed. Interactive mode implemented via --interactive flag.","dependencies":[{"issue_id":"docs-12","depends_on_id":"docs-9","type":"blocks","created_at":"2026-01-01T20:31:28.981762Z","created_by":"import"}]}
{"id":"docs-13","title":"llmemory: define archive indexing identity + metadata contract","description":"Define and implement the stable identity and metadata contract between archive-protocol and llmemory so indexing is idempotent and rebuildable.","design":"- Identity mapping:\n  - llmemory.owner_id = archive-protocol entity\n  - llmemory.id_at_origin = archive-protocol document_id\n- Add/standardize an `llmemory` section in the archive-protocol sidecar:\n  - indexed_at\n  - llmemory_document_id (if applicable)\n  - chunks_created\n  - embedding_model/provider\n- Ensure llmemory upsert logic uses (owner_id, id_at_origin) as a natural key to avoid duplicates.","acceptance_criteria":"- docs-sot/source-of-truth/llmemory-search.md matches code behavior.\n- Re-indexing the same archive items updates existing llmemory records (no duplicates).\n- archive metadata sidecars are updated with llmemory indexing fields.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-01T18:59:15.985534Z","created_by":"juanre","updated_at":"2026-01-02T00:04:47.979007Z","closed_at":"2026-01-02T00:04:37.806953Z","close_reason":"Implemented archive-protocol identity contract with upsert behavior. All 193 tests pass."}
{"id":"docs-14","title":"llmemory: build archive indexer + search CLI (primary search layer)","description":"Implement llmemory archive indexer + a minimal search CLI so llmemory becomes the primary search layer over ~/Archive.","design":"- Create an index command that scans base_path (default ~/Archive):\n  - discover archive-protocol content + sidecars\n  - extract/normalize text (PDF/MD/HTML/TXT; skip binaries)\n  - upsert to llmemory using the identity contract\n  - write llmemory fields back into sidecars atomically\n- Create a search command that queries llmemory with filters:\n  - entity, source, workflow, document_type, date range\n  - returns file paths + excerpt + score\n- Must be idempotent and safe to re-run.","acceptance_criteria":"- Indexer can scan and index an existing ~/Archive end-to-end.\n- Re-running does not duplicate logical documents in llmemory.\n- Search returns results with archive file paths and excerpts.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-01T18:59:24.655162Z","created_by":"juanre","updated_at":"2026-01-02T00:04:47.979642Z","closed_at":"2026-01-02T00:04:37.877965Z","dependencies":[{"issue_id":"docs-14","depends_on_id":"docs-13","type":"blocks","created_at":"2026-01-01T20:31:28.982237Z","created_by":"import"}]}
{"id":"docs-15","title":"mailflow: index to llmemory on write (default)","description":"Integrate mailflow with llmemory so newly archived items are indexed on write by default and become searchable immediately.","design":"- After mailflow writes content+sidecar via archive-protocol, extract searchable text.\n- Call llmemory upsert using (owner_id=entity, id_at_origin=document_id).\n- Update the sidecar llmemory section with returned identifiers/chunk counts.\n- Keep this idempotent; allow disabling only for troubleshooting (not as a long-term compatibility surface).","acceptance_criteria":"- End-to-end path: email -\u003e archived file+sidecar -\u003e llmemory record exists -\u003e `llmemory search` finds it.\n- Sidecar has llmemory indexing fields set.","notes":"Coordinator review: needs refactor. Requirements: (1) indexing on write is default =\u003e fail-fast if llmemory.database_url missing (no silent skip), (2) remove custom PyMuPDF/text extraction; reuse llmemory ArchiveIndexer (PDF via pypdf) and its atomic sidecar updates, (3) update sidecar llmemory section per SOT, (4) tests pass.","status":"closed","priority":2,"issue_type":"feature","assignee":"charlie","created_at":"2026-01-01T18:59:31.572281Z","created_by":"juanre","updated_at":"2026-01-03T12:08:30.523223Z","closed_at":"2026-01-03T12:08:30.523223Z","close_reason":"Merged to mailflow main; archive writes now index into llmemory via ArchiveIndexer (fail-fast on missing DB)","dependencies":[{"issue_id":"docs-15","depends_on_id":"docs-14","type":"blocks","created_at":"2026-01-01T20:31:28.982709Z","created_by":"import"}]}
{"id":"docs-16","title":"slack connector: ingest channels to archive-protocol + llmemory","description":"Build a Slack connector that archives channel history as streams and attachments as documents, using archive-protocol + llm-archivist + llmemory.","design":"- Connector outputs:\n  - daily (or chunked) transcripts written as streams under {entity}/streams/slack/{channel}/...\n  - attachments written as documents and classified into workflows when applicable\n- Use llm-archivist for workflow classification (binary LLM arbiter + vector fast-path).\n- Index transcripts and attachments into llmemory using the shared identity contract.","acceptance_criteria":"- Can ingest at least one channel end-to-end into ~/Archive.\n- Slack transcripts and attachments are searchable via llmemory.\n- Metadata sidecars include provenance sufficient to trace back to Slack (channel, message ts, file id/url).","notes":"Merged to docflow main: adds slackflow connector under ./slackflow.\\n\\nSOT alignment: reads token from ~/.config/docflow/config.toml [slack] with optional DOCFLOW_SLACK_TOKEN override; requires workflows.json in same config dir; attachment classification uses llm-archivist (no env mutation); workflow=null reserved for streams; attachments fall back to {entity}-docs only when classifier returns null; stream path uses channel_id (lowercased) for stability; provenance stored in sidecar origin (channel_id, channel_name, message ts, file id/url).\\n\\nValidation: unit tests 13/13 passing in slackflow.","status":"closed","priority":2,"issue_type":"feature","assignee":"charlie","created_at":"2026-01-01T18:59:38.740374Z","created_by":"juanre","updated_at":"2026-01-03T18:31:23.083775Z","closed_at":"2026-01-03T18:31:23.083775Z","close_reason":"Merged slackflow connector + passing tests","dependencies":[{"issue_id":"docs-16","depends_on_id":"docs-13","type":"blocks","created_at":"2026-01-01T20:31:28.983187Z","created_by":"import"}]}
{"id":"docs-17","title":"gdocs connector: ingest Drive/Docs to archive-protocol + llmemory","description":"Build a Google Drive/Docs connector that exports docs to durable formats and archives/indexes them via archive-protocol + llmemory, with workflow classification via llm-archivist.","design":"- Export strategy:\n  - Docs to PDF (+ optional Markdown) with stable filenames\n  - Preserve provenance (drive file id, url, folder path)\n- Classify into workflows (or null) via llm-archivist.\n- Write to ~/Archive via archive-protocol and index to llmemory.","acceptance_criteria":"- Can ingest at least one Drive folder end-to-end into ~/Archive.\n- Exported docs are searchable via llmemory.\n- Sidecars include provenance sufficient to trace back to Drive (file id/url, modified time).","notes":"Coordinator releasing in_progress/claim so charlie-agent can claim in his worktree.","status":"open","priority":2,"issue_type":"feature","assignee":"charlie-agent","created_at":"2026-01-01T18:59:44.815188Z","created_by":"juanre","updated_at":"2026-01-04T12:25:48.408973Z","dependencies":[{"issue_id":"docs-17","depends_on_id":"docs-13","type":"blocks","created_at":"2026-01-01T20:31:28.983661Z","created_by":"import"}]}
{"id":"docs-18","title":"docflow-archive: remove v1/compat options; hardcode v2 contract","description":"Remove backwards-compatibility options in docflow-archive and hardcode the v2 archive contract.","design":"- Remove config flags that switch layouts or enable legacy behavior.\\n- Keep one canonical layout (v2) as described in docflow-sot/source-of-truth/archive-protocol.md.\\n- Ensure year directory derivation, naming, and stream/document paths are v2-only.\\n- Update tests to validate only v2 behavior.","acceptance_criteria":"- archive-protocol has a single supported layout; legacy toggles are removed.\n- Tests validate v2 path construction and sidecar writing.\n- Documentation and code agree on the one layout.","status":"closed","priority":2,"issue_type":"chore","created_at":"2026-01-01T18:59:54.483029Z","created_by":"juanre","updated_at":"2026-01-02T15:44:14.020645Z","closed_at":"2026-01-02T15:44:14.020645Z","close_reason":"Merged into docflow-archive main (e3222f1); tests: 107 passed."}
{"id":"docs-19","title":"docflow-cli: expense post-processing + accountant/Xero export","description":"Implement expense extraction and CSV exports as archive-level post-processing (connector-neutral) so it works for mail, fs, slack, etc.","design":"- End-state: expense extraction + exports are provided by docflow-cli and operate on the archive + sidecars (connector-neutral).\n- mailflow is an ingest connector only; it MUST NOT implement or own any export CLI surface.\n- Persist extracted structured data in the docflow-archive metadata sidecar under accounting.expense (schema per docflow-sot/source-of-truth/accounting-expenses.md).\n- Extraction uses a strict JSON schema + validation; failures are explicit and do not corrupt the archive.\n- Interactive mode (dev): optional confirm/correct extracted fields and persist corrections.\n- Non-interactive end state: no prompts; LLM output is accepted as the arbiter, but all extracted data remains auditable via provenance fields.\n- Provide exports:\n  - expenses.csv (audit/export)\n  - xero-bills.csv (Xero import)\n  Both keyed by archive document_id and archive_path for traceability (per SOT).","acceptance_criteria":"- docflow-cli provides commands to extract accounting.expense into sidecars and to export stable CSV for a date range.\n- Works for documents regardless of source connector as long as they follow docflow-archive layout + sidecars.\n- Export is reproducible/idempotent for the same archive state.\n- No mailflow export commands exist (docflow is the only user-facing entrypoint for exports).\n- Tests updated/passing.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-01T22:22:37.362194Z","created_by":"juanre","updated_at":"2026-01-03T16:47:02.605739Z","closed_at":"2026-01-03T16:47:02.605739Z","close_reason":"SOT acceptance met: docflow-cli extracts accounting.expense, supports postprocess workflows, exports expenses.csv + xero-bills.csv with archive-relative paths; mailflow has no export CLI","dependencies":[{"issue_id":"docs-19","depends_on_id":"docs-9","type":"blocks","created_at":"2026-01-01T22:24:18.428854Z","created_by":"import"},{"issue_id":"docs-19","depends_on_id":"docs-10","type":"blocks","created_at":"2026-01-01T22:24:18.429471Z","created_by":"import"},{"issue_id":"docs-19","depends_on_id":"docs-18","type":"blocks","created_at":"2026-01-01T22:24:18.43004Z","created_by":"import"},{"issue_id":"docs-19","depends_on_id":"docs-22","type":"blocks","created_at":"2026-01-01T23:36:33.391778Z","created_by":"import"},{"issue_id":"docs-19","depends_on_id":"docs-25","type":"blocks","created_at":"2026-01-02T16:23:06.875987Z","created_by":"juanre"},{"issue_id":"docs-19","depends_on_id":"docs-26","type":"blocks","created_at":"2026-01-02T16:23:06.925338Z","created_by":"juanre"},{"issue_id":"docs-19","depends_on_id":"docs-27","type":"blocks","created_at":"2026-01-02T16:23:06.973748Z","created_by":"juanre"}]}
{"id":"docs-1ed","title":"docs-25: mailflow: pass source created_at to archive-protocol writer","description":"mailflow must pass the source-derived created_at (parsed from email Date) into archive-protocol.RepositoryWriter.write_document/write_stream so year bucketing and date-prefixed filenames reflect the source timestamp, not ingestion time.","design":"- Parse created_at from email Date (email.utils.parsedate_to_datetime) once per message; fallback to now only if missing/unparseable.\n- created_at MUST be timezone-aware. If parsed datetime is naive, assume UTC. Normalize to UTC for storage + path derivation.\n- Pass created_at=created_at to archive-protocol RepositoryWriter.write_document in save_pdf (PDF attachments + email-\u003ePDF) and in save_attachment/save_email_pdf.\n- Ensure write_original_file uses the same created_at so originals and docs align.","acceptance_criteria":"- All mailflow archived documents are bucketed by source created_at year, not ingestion time.\n- created_at values are timezone-aware (UTC-normalized).\n- tests/test_archive_layout_v2.py passes regardless of current year.\n- No regressions in mailflow tests.","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-02T12:21:20.683976Z","created_by":"juanre","updated_at":"2026-01-02T12:42:08.071691Z","closed_at":"2026-01-02T12:42:08.071691Z","close_reason":"Fixed in mailflow main (16769c1): passes source-derived created_at to archive-protocol writer; created_at is tz-aware + UTC-normalized; tests 202 passed."}
{"id":"docs-2","title":"Decide repo topology for archive-protocol + docs-sot","description":"Decide and enforce the repo topology for /Users/juanre/prj/docs.\n\nThis directory is a multi-repo workspace for the personal unified archive. We want a clean collaboration model with minimal git friction and a single coordination surface for planning (beads).","design":"Decision: keep /Users/juanre/prj/docs as a lightweight *workspace meta-repo* for coordination only.\n- Root repo tracks: beads (.beads/issues.jsonl), coordination docs (AGENTS.md), and lightweight workspace glue.\n- Product repos remain independent nested git repos: mailflow/, llm-archivist/, llmemory/, archive-protocol/, docs-sot/.\n- No submodules and no monorepo flattening.\n- Root repo must not accidentally vendor nested repo contents; keep them ignored.","acceptance_criteria":"- Root .gitignore ignores: archive-protocol/, docs-sot/, mailflow/, llm-archivist/, llmemory/, legacy/.\n- Root repo has no .gitmodules and no submodule entries.\n- Running `git status -sb` in the root never shows nested repo file changes.\n- Each nested repo can be operated independently (`git status -sb` inside each).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T18:57:38.100746Z","created_by":"juanre","updated_at":"2026-01-01T20:18:04.811489Z","closed_at":"2026-01-01T20:18:04.811489Z"}
{"id":"docs-20","title":"Docs-SOT: accounting/expense export contract","description":"Adjust the Source of Truth to include the end-state contract for expense extraction as a downstream effect of archiving/classification (especially workflows like tsm-expense): what fields get extracted, where they live (sidecar JSON), and how accountant-facing CSV exports are produced.","design":"- Expense extraction is downstream post-processing of archived artifacts (PDFs/attachments) produced by connectors; it is not a separate storage system.\n- Define a stable sidecar schema section for extracted expense data (accounting.expense) including totals, currency, dates, vendor, tax, and strong provenance back to the archived document.\n- Define CSV export contracts:\n  - expenses.csv (accountant-friendly / audit)\n  - xero-bills.csv (Xero import), with Reference including document_id and Description including archive_path.\n- Keep it end-state descriptive (no roadmap/migration language).\n- Implemented in docs-sot/source-of-truth/accounting-expenses.md.","acceptance_criteria":"- docs-sot/source-of-truth/accounting-expenses.md defines the sidecar schema (accounting.expense) and CSV export contracts (expenses.csv and xero-bills.csv).\n- The contracts are consistent with archive-protocol sidecar conventions (document_id + path traceability).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T22:19:32.580825Z","created_by":"juanre","updated_at":"2026-01-02T01:52:24.910245Z","closed_at":"2026-01-02T00:42:24.643649Z","dependencies":[{"issue_id":"docs-20","depends_on_id":"docs-1","type":"parent-child","created_at":"2026-01-01T22:22:05.649245Z","created_by":"import"}]}
{"id":"docs-21","title":"Docs-SOT: docflow config contract (~/.config/docflow)","description":"Define the end-state configuration contract for the Docflow project under ~/.config/docflow.\n\nGoal: a single, predictable configuration surface for mailflow + llm-archivist (+ llmemory where applicable), eliminating scattered per-tool config directories.","design":"- Config root: ~/.config/docflow (or $XDG_CONFIG_HOME/docflow).\n- Provide a single config file (format TBD: TOML/YAML/JSON) that includes:\n  - archivist: database connection + schema, similarity threshold\n  - mailflow: archive base path (~/Archive), entity defaults, workflow definitions location\n  - llmemory: database/url and any required indexing options\n- Secrets: decide whether DATABASE_URL lives in this file or in a referenced secrets file; end-state must be non-interactive and fail fast if required config is missing.\n- No backwards compatibility: mailflow should not continue reading ~/.config/mailflow once migrated.","acceptance_criteria":"- docs-sot/source-of-truth/ includes a configuration doc describing ~/.config/docflow layout, file names, and required keys.\n- SOT explicitly states that llm-archivist fails fast when DB config is missing.\n- Terminology matches SOT (entity, workflow, ARCHIVIST_SIMILARITY_THRESHOLD).","notes":"SOT now lives in docflow repo under docflow-sot/source-of-truth/ (docs-sot/ remains a local legacy workdir).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T23:29:40.768058Z","created_by":"juanre","updated_at":"2026-01-02T12:48:44.892976Z","closed_at":"2026-01-02T00:24:44.454693Z"}
{"id":"docs-22","title":"mailflow: migrate config to ~/.config/docflow + archivist DB preflight","description":"Switch mailflow to use ~/.config/docflow as its configuration root and fail fast when llm-archivist DB config is missing.","design":"- mailflow config root becomes $XDG_CONFIG_HOME/docflow (default: ~/.config/docflow).\n- Read archive.base_path + mailflow.* + archivist.* from config.toml; workflows.json lives alongside.\n- Preflight before any archive writes: require archivist.database_url + archivist.db_schema; error if missing.\n- No backwards compatibility with ~/.config/mailflow.","acceptance_criteria":"- mailflow reads config from ~/.config/docflow (or $XDG_CONFIG_HOME/docflow) only.\n- Running mailflow without archivist DB config fails fast with a clear error (no partial archive writes).\n- Tests updated to reflect new config location and fail-fast behavior.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-01T23:29:40.921665Z","created_by":"juanre","updated_at":"2026-01-02T12:16:06.435391Z","closed_at":"2026-01-02T12:16:06.435391Z","close_reason":"Complete: config migrated to ~/.config/docflow (TOML), preflight_archivist() added, DOCFLOW_* env vars for dev overrides. 4 commits on charlie/mailflow-docs-22. 201/202 tests pass (1 unrelated date-test failure).","dependencies":[{"issue_id":"docs-22","depends_on_id":"docs-21","type":"blocks","created_at":"2026-01-01T23:36:33.39269Z","created_by":"import"},{"issue_id":"docs-22","depends_on_id":"docs-1ed","type":"blocks","created_at":"2026-01-02T12:22:12.994818Z","created_by":"juanre"}]}
{"id":"docs-23","title":"llm-archivist: read config from ~/.config/docflow; fail fast without DB","description":"Make llm-archivist read required runtime configuration from ~/.config/docflow and fail fast if missing.","design":"- Read config from $XDG_CONFIG_HOME/docflow/config.toml (default: ~/.config/docflow/config.toml).\n- Required keys: [archivist].database_url, [archivist].db_schema, [archivist].similarity_threshold.\n- Fail fast on startup if required keys missing (no no-DB mode).\n- Optional env overrides allowed only if they map 1:1 to these keys and preserve fail-fast.","acceptance_criteria":"- llm-archivist fails fast if docflow config (or required DB keys) is missing.\n- Tests cover config resolution and the fail-fast path.\n- No references remain to ARCHIVIST_USE_DB.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-01T23:29:41.082187Z","created_by":"juanre","updated_at":"2026-01-02T12:42:03.566447Z","closed_at":"2026-01-02T12:42:03.566447Z","close_reason":"Merged into llm-archivist main (0d399e2): reads ~/.config/docflow/config.toml, requires file, DOCFLOW_ARCHIVIST_* overrides, tests 36 passed.","dependencies":[{"issue_id":"docs-23","depends_on_id":"docs-21","type":"blocks","created_at":"2026-01-01T23:36:33.393378Z","created_by":"import"}]}
{"id":"docs-24","title":"docflow-cli: init command to scaffold ~/.config/docflow","description":"Provide a simple way to create a correct ~/.config/docflow config skeleton for new machines.","design":"- Implement as `docflow init` in docflow-cli (the orchestration CLI).\n- Generates:\n  - ~/.config/docflow/config.toml\n  - ~/.config/docflow/workflows.json (stub/example)\n- Includes examples for:\n  - archive.base_path\n  - archivist.database_url, archivist.db_schema, archivist.similarity_threshold\n  - llmemory.database_url\n  - mailflow defaults (default_entity, workflows_path, mode)\n- Init may be interactive; all normal runtime commands must remain non-interactive and fail-fast if required config is missing.","acceptance_criteria":"- A user can run one command to generate a valid config skeleton in ~/.config/docflow.\n- The generated config matches the SOT contract and enables a successful preflight.","notes":"Released for Charlie to claim via bdh update docs-24 --claim. End-state per SOT: init may prompt; everything else non-interactive.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-01-01T23:29:41.237488Z","created_by":"juanre","updated_at":"2026-01-02T17:17:23.427211Z","closed_at":"2026-01-02T17:17:23.427211Z","close_reason":"Implemented docflow init command with interactive prompts for config.toml and workflows.json. All 5 tests pass.","dependencies":[{"issue_id":"docs-24","depends_on_id":"docs-21","type":"blocks","created_at":"2026-01-01T23:36:33.394071Z","created_by":"import"}]}
{"id":"docs-25","title":"docflow-cli: scaffold (config + preflight + command layout)","description":"Create the connector-neutral orchestration CLI described in docflow-sot/source-of-truth/system-overview.md.","design":"- Repo: new sibling repo directory \"docflow-cli/\" (python \u003e=3.12), installable script \"docflow\".\n- Reads config from \"~/.config/docflow/config.toml\" (or a --config flag).\n- Centralize config loading + path expansion + fail-fast preflight checks.\n- Preflight rules: commands that require archivist/llmemory DB must error if database_url is missing; no silent fallbacks or env-only configs.\n- Command layout (initial):\n  - docflow init (docs-24)\n  - docflow export expenses / docflow export xero-bills (docs-19)\n  - (later) docflow index llmemory (docs-15)\n- No backwards-compatibility flags; delete legacy knobs rather than shims.","acceptance_criteria":"- docflow --help works after install/dev run.\n- docflow loads config from ~/.config/docflow/config.toml and fails fast with clear error messages when required keys are missing.\n- Provides a reusable config loader module used by subcommands.\n- Adds minimal unit tests for config loading/preflight.","notes":"Merged to docflow main as 6253efd (includes c043815 fix); docflow-cli tests: 33 passed.","status":"closed","priority":1,"issue_type":"feature","assignee":"charlie","created_at":"2026-01-02T16:21:45.443043Z","created_by":"juanre","updated_at":"2026-01-02T17:12:26.316605Z","closed_at":"2026-01-02T17:12:26.316611Z","close_reason":"Created docflow-cli scaffold with config loader (from ~/.config/docflow/config.toml), preflight checks, and command layout (init, export). 29 tests pass. Commands are stubs pending docs-24/docs-26."}
{"id":"docs-26","title":"docflow-cli: export expenses.csv + xero-bills.csv (archive-level)","description":"Implement the export-only part of docs-19: read archive sidecars and emit accountant/Xero CSVs with strong traceability.","design":"- Operates only on the filesystem archive and sidecar JSONs written by docflow-archive.\n- Reads accounting.expense fields per docflow-sot/source-of-truth/accounting-expenses.md.\n- Produces:\n  - expenses.csv (audit/accountant)\n  - xero-bills.csv (Xero import)\n- Every row includes document_id + archive_path; Xero Reference includes document_id and Description includes archive_path.\n- No prompting: exporters are deterministic.\n- If a document lacks accounting.expense, exporter skips it by default; no LLM extraction inside export.\n- mailflow MUST NOT provide export commands; if any exist on branches, they must be removed (docflow-cli is the only entrypoint for exports).","acceptance_criteria":"- docflow-cli provides CLI commands to generate both CSVs for a given entity + date range.\n- Output is stable/idempotent for the same archive state.\n- Unit tests cover CSV headers/traceability rules and at least one fixture sidecar.\n- No mailflow export commands exist (docflow is the only user-facing entrypoint for exports).","notes":"Status corrected by coordinator: docflow-cli export commands are currently stubs (raise ClickException) as of docflow main 6253efd. docs-26 requires real implementation + tests + merge; close only after exports actually work.","status":"closed","priority":1,"issue_type":"task","assignee":"bob","created_at":"2026-01-02T16:21:57.513361Z","created_by":"juanre","updated_at":"2026-01-02T17:21:18.048467Z","closed_at":"2026-01-02T17:21:18.048467Z","close_reason":"Merged expense exports into docflow-cli (commits 2e68e79 + 0bdd0a5). docflow-cli tests: 42 passed.","dependencies":[{"issue_id":"docs-26","depends_on_id":"docs-25","type":"blocks","created_at":"2026-01-02T16:22:15.357306Z","created_by":"juanre"}]}
{"id":"docs-27","title":"docflow-cli: extract accounting.expense into sidecars (LLM, auditable)","description":"Implement the extraction part of docs-19: populate accounting.expense in archive sidecars by extracting totals/vendor/date/currency/etc from archived documents.","design":"- Command operates on archived documents already written via docflow-archive.\n- Extraction target is sidecar JSON field accounting.expense (schema in docflow-sot/source-of-truth/accounting-expenses.md).\n- Uses strict structured output (JSON schema + validation); on validation failure, do not write partial data.\n- Stores provenance in accounting.expense (extractor id/version, extracted_at timezone-aware UTC, and pointers to source_document_id/source_path).\n- Non-interactive end state: zero prompts; LLM output is accepted as arbiter.\n- Development interactive mode: optional confirm/correct loop that updates sidecars with corrected fields.\n- Avoid adding any new persistence layer: sidecars are the system of record; DB may be used only for LLM/archivist learning, not for expense truth.","acceptance_criteria":"- Running extraction produces valid accounting.expense blocks in sidecars for a set of known expense fixtures.\n- created_at/extracted_at timestamps are timezone-aware and normalized to UTC.\n- Interactive mode (when enabled) persists corrections; non-interactive mode never prompts.\n- Tests cover schema validation and sidecar write behavior (no writes on failure).","notes":"Coordinator: implementation exists on origin/bob-docflow-cli-docs-26 (commit 6757904) but is not yet reviewed/merged. Keep docs-27 open until merged + validated.","status":"closed","priority":1,"issue_type":"feature","assignee":"bob","created_at":"2026-01-02T16:22:06.244502Z","created_by":"juanre","updated_at":"2026-01-03T12:08:24.226277Z","closed_at":"2026-01-03T12:08:24.226277Z","close_reason":"Merged to docflow main; expense postprocessor shipped (requires real LLM keys to pass LLM integration tests)","dependencies":[{"issue_id":"docs-27","depends_on_id":"docs-25","type":"blocks","created_at":"2026-01-02T16:22:15.40467Z","created_by":"juanre"}]}
{"id":"docs-28","title":"llm-archivist/mailflow: remove ARCHIVIST_PERSIST_EMBED knob (docs + code)","description":"Remove the confusing embedding-persistence toggle entirely; embeddings must persist whenever vectors are used.","design":"- Delete any remaining references to ARCHIVIST_PERSIST_EMBED in code and documentation.\n- If an env override mechanism exists, it must map 1:1 to config.toml keys only (e.g., DOCFLOW_ARCHIVIST_SIMILARITY_THRESHOLD), not introduce new behavior.\n- Update READMEs to reflect: embeddings persist by definition; llm-archivist requires DB; fail fast if database_url missing.","acceptance_criteria":"- No repo mentions ARCHIVIST_PERSIST_EMBED in code or docs.\n- Tests pass in affected repos.","notes":"ARCHIVIST_PERSIST_EMBED removed from docs; llm-archivist includes 91fba0b; mailflow includes 6d35cd5 (181 tests passed).","status":"closed","priority":1,"issue_type":"task","assignee":"charlie","created_at":"2026-01-02T16:25:37.589132Z","created_by":"juanre","updated_at":"2026-01-02T17:12:26.433815Z","closed_at":"2026-01-02T17:12:26.433819Z","close_reason":"Removed ARCHIVIST_PERSIST_EMBED from llm-archivist and mailflow READMEs. Tests pass in both repos."}
{"id":"docs-29","title":"E2E: mailflow → expense postprocess → Xero CSV","description":"Run a real end-to-end expense extraction/export using the finished architecture (mailflow archives into ~/Archive, llm-archivist classifies, docflow-cli postprocesses, export produces Xero-importable CSV). This is an operational acceptance bead: it should surface any remaining architecture gaps, not add new knobs.","design":"Use ONLY the SOT contracts in docflow-sot/source-of-truth/ (configuration.md, workflows.md, accounting-expenses.md, postprocessing.md).\\n\\nGolden path (non-interactive):\\n- Ensure ~/.config/docflow/config.toml has [archive], [archivist], [llmemory], [mailflow] and similarity_threshold set high (e.g. 0.95).\\n- Ensure ~/.config/docflow/workflows.json includes {entity}-docs and at least one expense workflow (tsm-expense) with postprocessor accounting.expense.\\n- Ingest a bounded mailbox slice (date range) that contains known expense emails.\\n- Run docflow postprocess for tsm-expense (and/or docflow extract expenses) to populate accounting.expense blocks.\\n- Export xero-bills.csv and verify required traceability: Reference includes document_id, Description includes archive_path; archive_path points to the correct archived source.\\n\\nStrictness:\\n- No interactive prompting in this bead except where SOT explicitly allows interactive validation mode during development; the acceptance run must be non-interactive.\\n- Fail fast if config/db missing (no partial writes).\\n- Do not skip tests by default; if any tests fail, either fix or document as unrelated.","acceptance_criteria":"- Demonstrate commands + outputs for one real run producing xero-bills.csv for entity tsm.\\n- CSV rows are accountant-usable and each row can be traced to an archived file (archive_path exists under ~/Archive).\\n- At least one expense document successfully extracted with vendor, expense_date, total_amount, currency, category=uncategorized or better.\\n- Any bugs found are fixed on main or captured as new beads with clear reproduction steps.","notes":"Policy decision (chat 2026-01-04): for expense workflows, classifier must return null unless an invoice/receipt document is present; payment confirmations (e.g., Wise) are expected to be null. For E2E validation, pick at least one email with an actual invoice/receipt attachment.","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-03T18:54:27.273176Z","created_by":"juanre","updated_at":"2026-01-04T10:52:38.47146Z","dependencies":[{"issue_id":"docs-29","depends_on_id":"docs-19","type":"blocks","created_at":"2026-01-03T18:54:27.274983Z","created_by":"juanre"},{"issue_id":"docs-29","depends_on_id":"docs-22","type":"blocks","created_at":"2026-01-03T18:54:27.275882Z","created_by":"juanre"},{"issue_id":"docs-29","depends_on_id":"docs-26","type":"blocks","created_at":"2026-01-03T18:54:27.276528Z","created_by":"juanre"},{"issue_id":"docs-29","depends_on_id":"docs-1","type":"parent-child","created_at":"2026-01-03T18:54:30.282473Z","created_by":"juanre"},{"issue_id":"docs-29","depends_on_id":"docs-mba","type":"relates-to","created_at":"2026-01-04T11:02:37.969838Z","created_by":"juanre"},{"issue_id":"docs-29","depends_on_id":"docs-e9s","type":"relates-to","created_at":"2026-01-04T11:02:38.176339Z","created_by":"juanre"}]}
{"id":"docs-3","title":"Finalize cleanup: legacy/, docflow-archive/, docs-sot/ and commit","description":"Finalize the current cleanup and make the workspace consistent: move non-future projects under legacy/, ensure docflow-archive is its own repo, retire docs-sot in favor of docflow-sot, update mailflow dependencies, and commit coordination state.","design":"- Ensure legacy/ contains all non-future repos/attempts.\\n- Ensure docflow-archive/ is the single shared archive protocol repo and all callers use it via dependency (no vendored copies).\\n- Ensure docflow-sot/source-of-truth/ is the only end-state SOT docs location; treat docs-sot/ as legacy and remove/move it.\\n- Ensure each affected repo has a clean working tree and its own commits for the changes it owns.\\n- Root repo commits the beads plan (.beads/issues.jsonl) and workspace-level ignores/config.","acceptance_criteria":"- Root repo: clean git status -sb after committing coordination changes.\\n- mailflow/: clean git status -sb and tests pass (uv run pytest -q).\\n- docflow-archive/: clean git status -sb and tests pass (uv run pytest -q).\\n- docflow-sot/source-of-truth/: end-state docs read cleanly and contain no planning/transition content.\\n- legacy/ contains only projects we are not actively evolving.","notes":"Next for Charlie: finish cleanup chore. Verify legacy/ contains non-future attempts, docs-sot is fully retired (only docflow-sot used), and remove any stray worktree symlinks/untracked dirs (e.g., file-classifier-core). Confirm mailflow + docflow-archive + docflow-cli have clean status and tests pass.","status":"closed","priority":1,"issue_type":"chore","assignee":"charlie","created_at":"2026-01-01T18:58:01.156543Z","created_by":"juanre","updated_at":"2026-01-02T17:36:06.47235Z","closed_at":"2026-01-02T17:36:06.47235Z","close_reason":"Cleanup complete: legacy/ verified, docs-sot retired to legacy/, gitignore updated for symlinks, all tests pass (docflow-cli 38, mailflow 181, docflow-archive 107).","dependencies":[{"issue_id":"docs-3","depends_on_id":"docs-2","type":"blocks","created_at":"2026-01-01T20:31:28.984142Z","created_by":"import"}]}
{"id":"docs-4","title":"Docs-SOT: complete end-state spec (no prompting, llmemory primary)","description":"Ensure docs-sot/source-of-truth fully and consistently describes the finished system (what it is and why), with no roadmap/migration/planning content.","design":"- Keep SOT purely descriptive: end-state behavior, contracts, invariants, and terminology.\n- Single source of truth for the policy surface (especially ARCHIVIST_SIMILARITY_THRESHOLD and “interactive vs non-interactive”).\n- No docs with transitional naming (e.g., *-simplification*, *roadmap*, *migration*).","acceptance_criteria":"- docs-sot/source-of-truth/ contains only end-state docs (no roadmap/migration/simplification).\n- Terms are consistent across docs: LLM is arbiter, vector KNN is fast-path, no backwards compatibility, llmemory is primary search layer.\n- A reviewer can implement core behaviors from SOT without reading code.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T18:58:08.833753Z","created_by":"juanre","updated_at":"2026-01-01T20:18:07.600903Z","closed_at":"2026-01-01T20:18:07.600903Z"}
{"id":"docs-44x","title":"workflows.json: workflow kinds + handling intents (connector-neutral)","description":"Define workflows as (a) normative classification criteria + (b) desired handling intent, so connectors can behave consistently across origins (email/files/slack/etc). Replace any workflow-name heuristics in code; workflows.json becomes the single source for what a workflow means and what should happen when matched.","design":"Decision: We choose option (2): workflows define BOTH (a) normative applicability criteria and (b) connector-neutral handling intent.\n\nMotivation:\n- We will have many workflow families beyond expenses: archive mailbox moves, reply suggestions/drafts, durable document archiving, tax docs, etc. Workflows cannot be 'just expense buckets'.\n- Today llm-archivist has workflow-name substring heuristics (expense/invoice/receipt) which makes meaning split between workflows.json + code. This must be removed.\n- Private/local project: prompt injection is not a primary threat, but architecture must be clean, testable, and drift-resistant.\n\nCurrent state (baseline schema): workflows.json entries are effectively {name, description?, postprocessors?} (+ optional tags in some connectors). That is insufficient to express handling intent.\n\nTarget: workflows.json vNext\n- Add top-level schema/version marker (e.g., {schema_version: 1, workflows: [...]}) and require it (no back-compat).\n- Each workflow entry declares:\n  - name (required)\n  - kind (required): stable enum controlling both classification rubric and handling primitives.\n  - criteria (required, structured): normative description of what items match this workflow across origins.\n    - criteria must be representable as data, not per-workflow arbitrary prompt text.\n    - allow human-authored freeform summary fields for inspection, but they are not the only semantic.\n  - handling (required, structured): connector-neutral intent. Examples of primitives:\n    - archive: {target: document|stream|none, doctype: \u003cstable\u003e, entity: \u003cstable?\u003e}\n    - mail: {action: move|label|none, mailbox: \u003cid/name\u003e, labels: [...]}\n    - reply: {action: draft|suggest|none, channel: \u003corigin\u003e}\n    - index: {llmemory: true|false} (default true for anything archived)\n  - postprocessors (existing): downstream archive-level enrichments.\n\nEvidence constraints (general mechanism)\n- Workflows may express required evidence in criteria/constraints. This is not expense-specific; it applies to any workflow family.\n- Specific decision from this chat (expense policy): for company-paid expenses, classification must return null unless an invoice/receipt document is present (typically a PDF attachment). Payment confirmations (e.g., Wise) are NOT enough.\n\nLLM architecture (no user prompting)\n- End-state: no user prompting. Interactive mode exists only during development as a validation layer.\n- LLM prompting is internal: llm-archivist uses a generic prompt template parameterized by workflow.kind + criteria + constraints, never by workflow name substring heuristics.\n- The 'criteria' field is the normative meaning; code provides the generic arbitration frame (choose label or null; never invent labels).\n\nConnector behavior\n- Connectors must interpret handling primitives; if a workflow requests primitives a connector cannot implement, the connector must fail fast or reject that workflow at preflight.\n\nNo tech debt / no backwards compatibility\n- Require the new workflows.json schema; do not support legacy shapes and do not implement migration code.","acceptance_criteria":"- docflow-sot updated to define workflows.json schema_version + fields (kind/criteria/handling) and to enumerate stable kinds.\n- llm-archivist: remove workflow-name substring heuristics; arbiter prompt uses only workflow.kind/criteria/constraints.\n- At least these workflow families are representable: expenses, tax-docs, archive-mailbox move, reply-draft/suggest, general-docs, stream.\n- Validation and loaders (mailflow/slackflow/docflow-cli/etc) fail fast on missing/invalid schema_version or required fields.\n- Tests cover the explicit policy: payment confirmations without invoice/receipt =\u003e label=null for expense workflows; invoice/receipt present =\u003e label=expense.","status":"open","priority":1,"issue_type":"feature","created_at":"2026-01-04T09:23:26.649697Z","created_by":"juanre","updated_at":"2026-01-04T10:50:34.484905Z"}
{"id":"docs-44x.1","title":"SOT: workflows.json vNext schema (kind/criteria/handling + schema_version)","description":"Update docflow-sot to define workflows.json vNext: add top-level schema_version and required workflow fields kind, criteria, handling, postprocessors. Enumerate stable workflow kinds and connector-neutral handling primitives.","design":"This is SOT-only: describe end-state behavior and schema, not implementation steps.","acceptance_criteria":"- docflow-sot/source-of-truth/configuration.md workflows.json contract updated.\n- docflow-sot/source-of-truth/workflows.md updated to describe kind/criteria/handling and represent workflow families (expenses, tax-docs, archive-mailbox, reply-draft/suggest, general-docs, stream).\n- docflow-sot/source-of-truth/classification.md updated to reference kind/criteria/constraints and explicitly forbids name-substring heuristics.\n- No backwards-compat/migration language.","status":"closed","priority":1,"issue_type":"task","assignee":"charlie-agent","created_at":"2026-01-04T11:55:34.010949Z","created_by":"juanre","updated_at":"2026-01-04T12:29:49.5483Z","closed_at":"2026-01-04T12:29:49.5483Z","close_reason":"Duplicate of docs-44x.2; consolidated SOT workflows.json vNext schema work into docs-44x.2."}
{"id":"docs-44x.2","title":"SOT: workflows.json vNext schema (kind/criteria/handling + schema_version)","description":"Update docflow-sot to define workflows.json vNext: add top-level schema_version and required workflow fields kind, criteria, handling, postprocessors. Enumerate stable workflow kinds and connector-neutral handling primitives.","design":"SOT-only: describe the finished schema/behavior, not implementation steps.","acceptance_criteria":"- configuration.md updates workflows.json contract (schema_version + fields).\n- workflows.md documents workflow families (expenses, tax-docs, archive-mailbox move, reply-draft/suggest, general-docs, stream) via kind/criteria/handling.\n- classification.md forbids workflow-name substring heuristics; references kind/criteria/constraints.\n- No backwards-compat/migration language.","status":"closed","priority":1,"issue_type":"task","assignee":"charlie-agent","created_at":"2026-01-04T12:20:06.346603Z","created_by":"juanre","updated_at":"2026-01-04T12:44:11.412483Z","closed_at":"2026-01-04T12:44:11.412483Z","close_reason":"Done","dependencies":[{"issue_id":"docs-44x.2","depends_on_id":"docs-44x","type":"parent-child","created_at":"2026-01-04T12:20:06.347228Z","created_by":"juanre"}]}
{"id":"docs-44x.3","title":"docflow-cli: enforce workflows.json vNext schema","description":"Update docflow-cli workflow loader and init scaffolding to require the SOT workflows.json vNext contract (schema_version=1; each workflow has name/kind/criteria/constraints?/handling/postprocessors?). No legacy parsing or migration.","design":"Read SOT first: docflow-sot/source-of-truth/configuration.md and docflow-sot/source-of-truth/workflows.md. Workflows are typed intents: meaning comes from kind+criteria+constraints, never from workflow name substrings. docflow-cli must validate workflows.json strictly and provide a typed in-memory representation used by postprocessing and connector preflight.","acceptance_criteria":"1) docflow_cli/workflows.py rejects workflows.json missing schema_version or with non-1 schema_version.\n2) docflow_cli/workflows.py rejects any workflow missing required fields: name, kind, criteria.summary, handling.\n3) docflow init writes a vNext workflows.json example (schema_version=1) consistent with SOT.\n4) No code path accepts legacy workflows.json shapes.\n5) Tests updated and passing.","status":"closed","priority":1,"issue_type":"task","assignee":"charlie-agent","created_at":"2026-01-04T13:34:15.596981Z","created_by":"juanre","updated_at":"2026-01-04T16:17:08.851495Z","closed_at":"2026-01-04T16:17:08.851495Z","close_reason":"Done","dependencies":[{"issue_id":"docs-44x.3","depends_on_id":"docs-44x","type":"parent-child","created_at":"2026-01-04T13:34:15.597701Z","created_by":"juanre"}]}
{"id":"docs-44x.4","title":"mailflow: use workflows.json vNext + handling primitives (no name parsing)","description":"Refactor mailflow to treat workflows.json as the single source of workflow meaning (vNext schema_version=1). Remove all parsing of entity/doctype/semantics from workflow name. Use workflow.kind/criteria/constraints for classification and workflow.handling primitives for execution (archive/mail/reply/index). Fail fast if workflows.json missing/invalid or if a selected workflow requests unsupported handling.","design":"SOT: docflow-sot/source-of-truth/workflows.md + configuration.md + classification.md. This must delete legacy/migration code in src/mailflow/models.py and remove parse_entity_from_workflow/parse_doctype_from_workflow reliance in archive-protocol actions. Mailflow may still choose connector-specific artifact(s) (e.g., prefer PDF attachment if evidence_sources includes attachment_pdf), but the target entity/doctype/archive target comes from workflow.handling.archive.","acceptance_criteria":"1) mailflow loads ~/.config/docflow/workflows.json vNext only (schema_version=1); no migration/legacy shapes.\n2) mailflow passes workflows to llm-archivist in vNext shape (name/kind/criteria/constraints/handling/postprocessors) and llm-archivist is invoked with that.\n3) Workflow execution uses workflow.handling.* (not name parsing) to determine entity/doctype/target.\n4) ripgrep in mailflow/src finds zero uses of parse_entity_from_workflow or parse_doctype_from_workflow or \"Detected legacy workflows\".\n5) Full mailflow test suite passes.","status":"closed","priority":1,"issue_type":"feature","assignee":"charlie-agent","created_at":"2026-01-04T17:47:19.260657Z","created_by":"juanre","updated_at":"2026-01-04T18:15:57.525529Z","closed_at":"2026-01-04T18:15:57.525529Z","close_reason":"Completed","dependencies":[{"issue_id":"docs-44x.4","depends_on_id":"docs-44x","type":"parent-child","created_at":"2026-01-04T17:47:19.262641Z","created_by":"juanre"}]}
{"id":"docs-44x.5","title":"slackflow: enforce workflows.json vNext + pass workflows to llm-archivist","description":"Update slackflow to require workflows.json vNext (schema_version=1) and pass workflows to llm-archivist using the vNext shape (name/kind/criteria/constraints/handling/postprocessors). Remove any reliance on workflow.description/tags and fail fast on invalid schema.","design":"SOT: docflow-sot/source-of-truth/configuration.md + workflows.md. This is a connector-neutral contract; workflow name is identifier only. Even if slackflow doesn’t execute all handling primitives yet, it must at least validate workflows.json and never infer semantics from name substrings.","acceptance_criteria":"1) slackflow rejects workflows.json missing schema_version or with non-1 schema_version.\n2) slackflow passes workflow dicts in vNext shape to llm-archivist.\n3) No references remain to workflow.description/tags in slackflow workflow loading.\n4) slackflow tests pass.","status":"open","priority":2,"issue_type":"chore","assignee":"bob-agent","created_at":"2026-01-04T17:47:25.905772Z","created_by":"juanre","updated_at":"2026-01-04T17:47:25.905772Z","dependencies":[{"issue_id":"docs-44x.5","depends_on_id":"docs-44x","type":"parent-child","created_at":"2026-01-04T17:47:25.906491Z","created_by":"juanre"}]}
{"id":"docs-5","title":"llm-archivist: make LLM advisor binary (label or null)","description":"Update llm-archivist so the LLM advisor is strictly binary: it returns a workflow label or null (no self-reported confidence), plus a rationale.","design":"- Define an explicit JSON output schema: {label: string|null, rationale: string}.\n- Validate/parse strictly; treat parse failures as label=null (or hard error if configured).\n- Map to Decision confidence semantics:\n  - label != null =\u003e confidence = 1.0\n  - label == null =\u003e confidence = 0.0\n- Remove any downstream logic that interprets LLM confidence as a numeric scale.\n- llm-archivist must fail fast if DATABASE_URL is not configured (no no-DB mode).","acceptance_criteria":"- Unit tests cover: label chosen, label=null, malformed JSON handling.\n- No code path relies on numeric LLM confidence.\n- Public API/CLI output reflects binary LLM confidence semantics.\n- Startup without DATABASE_URL fails fast with a clear error.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-01T18:58:17.930596Z","created_by":"juanre","updated_at":"2026-01-01T23:26:01.801771Z","closed_at":"2026-01-01T22:32:13.640239Z","close_reason":"LLM advisor now binary: output schema {label, rationale}, confidence derived as 1.0 (label) or 0.0 (null). Tests updated and passing.","dependencies":[{"issue_id":"docs-5","depends_on_id":"docs-23","type":"blocks","created_at":"2026-01-01T23:36:33.394603Z","created_by":"import"}]}
{"id":"docs-6","title":"llm-archivist: simplify to vector+LLM arbiter with ARCHIVIST_SIMILARITY_THRESHOLD","description":"Refactor llm-archivist classification policy to exactly two mechanisms: vector KNN fast-path gated by ARCHIVIST_SIMILARITY_THRESHOLD, else LLM binary arbiter fallback. Remove all other advisors/threshold knobs (no backwards compatibility).","design":"- Remove RulesAdvisor / LocalSimilarityAdvisor and any cascade/high-threshold configuration.\n- Require Postgres for all runs: classifier fails fast if DATABASE_URL is not set.\n- Implement policy:\n  1) Retrieve top-K neighbors (filtered to the candidate workflow names).\n  2) If top similarity \u003e= ARCHIVIST_SIMILARITY_THRESHOLD: accept without LLM.\n  3) Else: call LLM advisor (binary label-or-null). Optionally include top-K candidates as context to reduce label hallucination.\n- Persist decision + embedding for learning.\n- Ensure exactly one threshold knob remains exposed.","acceptance_criteria":"- Tests validate both branches: KNN short-circuit vs LLM call.\n- Only ARCHIVIST_SIMILARITY_THRESHOLD remains as the “skip LLM” decision boundary.\n- Startup without DATABASE_URL fails fast with a clear error.\n- No references remain to removed knobs (high_threshold, rules, local similarity).","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-01T18:58:24.300632Z","created_by":"juanre","updated_at":"2026-01-01T23:26:01.802535Z","closed_at":"2026-01-01T23:10:32.784498Z","close_reason":"Simplified to vector+LLM arbiter: removed RulesAdvisor/LocalSimilarityAdvisor, added ARCHIVIST_SIMILARITY_THRESHOLD (default 0.85), updated decision logic, CLI, and tests.","dependencies":[{"issue_id":"docs-6","depends_on_id":"docs-5","type":"blocks","created_at":"2026-01-01T20:31:28.984632Z","created_by":"import"},{"issue_id":"docs-6","depends_on_id":"docs-23","type":"blocks","created_at":"2026-01-01T23:36:33.395126Z","created_by":"import"}]}
{"id":"docs-7","title":"llm-archivist: ensure feedback updates vector behavior","description":"Ensure that user feedback/corrections actually change future vector KNN behavior in llm-archivist.","design":"- Define “effective label” for a stored decision as:\n  - corrected label if feedback exists\n  - else original decision label\n- Implement vector retrieval so returned neighbors reflect effective labels.\n  - Preferred approach: join/overlay feedback at query-time (no embedding rewrite required).\n- Add an explicit test demonstrating the correction loop.\n- llm-archivist always requires Postgres; no no-DB mode.","acceptance_criteria":"- A test shows: classify -\u003e store decision -\u003e add feedback(correct_label) -\u003e subsequent classify with vectors prefers corrected label.\n- Vector neighbor reporting/evidence shows corrected labels when present.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T18:58:31.056577Z","created_by":"juanre","updated_at":"2026-01-02T01:52:24.911413Z","closed_at":"2026-01-02T00:07:10.043987Z","dependencies":[{"issue_id":"docs-7","depends_on_id":"docs-6","type":"blocks","created_at":"2026-01-01T20:31:28.985124Z","created_by":"import"}]}
{"id":"docs-8","title":"llm-archivist: remove ARCHIVIST_PERSIST_EMBED and always persist embeddings","description":"Remove ARCHIVIST_PERSIST_EMBED and related code paths. Embeddings are always persisted (Postgres + pgvector) because llm-archivist cannot run without a database.","design":"- Delete ARCHIVIST_PERSIST_EMBED env var and any branching behavior it controls.\n- Embeddings persist by definition (llm-archivist always runs against Postgres).\n- Update docs and tests to reflect “no backwards compatibility”.","acceptance_criteria":"- Codebase has zero references to ARCHIVIST_PERSIST_EMBED.\n- llm-archivist refuses to run without DATABASE_URL.\n- Tests updated/passing.","status":"closed","priority":2,"issue_type":"chore","created_at":"2026-01-01T18:58:37.56074Z","created_by":"juanre","updated_at":"2026-01-02T13:00:00.226846Z","closed_at":"2026-01-02T13:00:00.226846Z","close_reason":"Merged into llm-archivist main (4a5518a): removed ARCHIVIST_PERSIST_EMBED; embeddings always persist. Tests: 36 passed.","dependencies":[{"issue_id":"docs-8","depends_on_id":"docs-6","type":"blocks","created_at":"2026-01-01T20:31:28.985625Z","created_by":"import"},{"issue_id":"docs-8","depends_on_id":"docs-23","type":"blocks","created_at":"2026-01-01T23:36:33.395659Z","created_by":"import"}]}
{"id":"docs-8vd","title":"docflow-cli: postprocess runner scans archive docs and filters by workflow","description":"Postprocess runner currently uses extract.expense.find_documents_for_extraction(), which (a) only returns docs missing accounting.expense (not generic) and (b) does not filter by workflow when --workflow is used. Fix runner to scan archive-protocol sidecars via docflow_cli.archive.iter_archive_documents(), filter docs by sidecar.workflow when --workflow is specified, and let postprocessors decide skip/overwrite.","status":"closed","priority":1,"issue_type":"bug","assignee":"alice","created_at":"2026-01-03T12:10:59.426274Z","created_by":"juanre","updated_at":"2026-01-03T12:11:58.061964Z","closed_at":"2026-01-03T12:11:58.061964Z","close_reason":"Implemented: postprocess scans archive-protocol sidecars via iter_archive_documents and filters by workflow_name when --workflow is used; updated tests","dependencies":[{"issue_id":"docs-8vd","depends_on_id":"docs-zq1","type":"discovered-from","created_at":"2026-01-03T12:10:59.428157Z","created_by":"juanre"}]}
{"id":"docs-9","title":"mailflow: remove local similarity engine and criteria_instances.json","description":"Remove mailflow’s local similarity/learning engine and criteria_instances.json; mailflow should rely exclusively on llm-archivist for workflow classification.","design":"- Delete SimilarityEngine + criteria_instances.json read/write paths.\n- Remove any local “training” logic and similarity thresholds.\n- Ensure mailflow’s classification step is: build (text, meta, workflows) -\u003e call llm-archivist -\u003e obtain label/null.","acceptance_criteria":"- criteria_instances.json is no longer used or created.\n- mailflow only calls llm-archivist for classification.\n- mailflow test suite passes.","notes":"Merged into mailflow/main and pushed (main commit cc16daa). Tests: 184 passed.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-01T18:58:46.317221Z","created_by":"juanre","updated_at":"2026-01-02T13:25:39.936497Z","closed_at":"2026-01-02T13:11:52.725086Z","close_reason":"Removed similarity.py, CriteriaInstance, and all criteria methods. Classification now uses only llm-archivist. All 184 tests pass. Committed df81ff6 to charlie/mailflow-docs-9.","dependencies":[{"issue_id":"docs-9","depends_on_id":"docs-6","type":"blocks","created_at":"2026-01-01T20:31:28.986145Z","created_by":"import"},{"issue_id":"docs-9","depends_on_id":"docs-22","type":"blocks","created_at":"2026-01-01T23:36:33.396181Z","created_by":"import"}]}
{"id":"docs-9dl","title":"docflow-cli: store accounting.expense.source_path as archive-relative path","description":"SOT (docflow-sot/source-of-truth/accounting-expenses.md) requires exports to include archive_path resolvable within archive root. Current docflow-cli expense postprocessor writes accounting.expense.source_path as an absolute filesystem path (str(content_path)). Change to write an archive-root-relative path (e.g. tsm/mail/tsm-expense/2024/.../invoice.pdf). Implementation likely: pass archive_root context into Postprocessor.run_one via config dict, compute content_path.relative_to(archive_root), and error if content is outside archive root. Update any tests accordingly and ensure export uses this stable path.","notes":"Landed on docflow/main: 93c4cc3 (archive-relative source_path + tests) and de1cf5b (also pass archive_root from extract command so source_path stays portable). Earlier close_reason referenced bob branch commit 5688191; final implementation is on main.","status":"closed","priority":2,"issue_type":"bug","assignee":"bob","created_at":"2026-01-03T13:15:28.223297Z","created_by":"juanre","updated_at":"2026-01-03T13:41:10.303462Z","closed_at":"2026-01-03T13:23:07.183167Z","close_reason":"Implemented archive-relative source_path. Commit 5688191 on bob-docflow-cli-docs-27 branch.","dependencies":[{"issue_id":"docs-9dl","depends_on_id":"docs-27","type":"discovered-from","created_at":"2026-01-03T13:15:28.22486Z","created_by":"juanre"}]}
{"id":"docs-9e5","title":"SOT: codify expense evidence requirement (invoice/receipt-only)","description":"Capture the agreed expense policy in the source-of-truth docs: expense workflows must classify null unless an actual invoice/receipt document is present; payment confirmations alone are not sufficient.","design":"- Update docflow-sot/source-of-truth/accounting-expenses.md and classification.md to state this explicitly.\n- Ensure examples include 'Wise payment confirmation =\u003e null for expense workflows' unless invoice/receipt attached.\n- Keep it phrased as end-state behavior (no implementation plan).","acceptance_criteria":"- SOT docs explicitly state invoice/receipt evidence requirement for expenses.\n- No contradictory language remains (e.g., implying bank transfer notifications might count).","status":"closed","priority":1,"issue_type":"task","assignee":"charlie-agent","created_at":"2026-01-04T10:50:58.741689Z","created_by":"juanre","updated_at":"2026-01-04T12:44:15.439704Z","closed_at":"2026-01-04T12:44:15.439704Z","close_reason":"Done","dependencies":[{"issue_id":"docs-9e5","depends_on_id":"docs-44x","type":"parent-child","created_at":"2026-01-04T12:19:44.012858Z","created_by":"juanre"}]}
{"id":"docs-aw8","title":"mailflow: accept archivist label + pass PDF attachments to classifier","description":"Mailflow non-interactive mode must accept llm-archivist decision.label even when decision.candidates/rankings are empty (LLM-only decisions). Also, llm-archivist must receive real PDF attachments as context when present, not only rendered HTML emails.","acceptance_criteria":"- Non-interactive mailflow accepts decision.label when valid, regardless of candidates.\n- classify_with_archivist prefers real PDF attachment (largest *.pdf) as pdf_path.\n- Tests cover both behaviors.","notes":"Implemented in mailflow main: commit 2cddc69 (plus tests).","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-03T23:28:29.183621Z","created_by":"juanre","updated_at":"2026-01-03T23:28:46.823029Z","closed_at":"2026-01-03T23:28:46.823029Z","close_reason":"Implemented in mailflow main (2cddc69): accept decision.label; prefer PDF attachment context; tests added.","dependencies":[{"issue_id":"docs-aw8","depends_on_id":"docs-29","type":"discovered-from","created_at":"2026-01-03T23:28:29.186279Z","created_by":"juanre"}]}
{"id":"docs-biv","title":"docs-26: archive-protocol: timezone-aware timestamps (UTC)","description":"Ensure docflow-archive (archive-protocol library) never emits naive datetimes: created_at/ingested_at in metadata and any date-derived pathing must be timezone-aware and normalized to UTC.","design":"- In docflow-archive/src/archive_protocol/writer.py: if created_at is None, use datetime.now(timezone.utc) (not naive).\\n- In docflow-archive/src/archive_protocol/metadata.py: ingested_at must be timezone-aware UTC.\\n- Validate/normalize: if a caller passes a naive created_at, assume UTC and normalize to UTC.\\n- Ensure JSON sidecar timestamps are ISO 8601 with timezone offset (UTC).\\n\\nNote: mailflow's vendored copy was fixed and released in mailflow/main (cc16daa); this bead tracks the standalone docflow-archive repo contract.","acceptance_criteria":"- No usage of datetime.now() without timezone in docflow-archive/src/archive_protocol.\\n- Metadata sidecars contain timezone-aware ISO timestamps.\\n- Tests cover naive vs aware input and assert UTC-normalized output.","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-02T12:27:03.558113Z","created_by":"juanre","updated_at":"2026-01-02T13:37:11.40744Z","closed_at":"2026-01-02T13:37:11.40744Z","close_reason":"Merged tz-aware UTC timestamps into docflow-archive main (c75c9fc); tests: 107 passed."}
{"id":"docs-dmc","title":"LLM arbiter prompting: templates per workflow kind (no per-workflow freeform prompt)","description":"Define how llm-archivist builds its internal system/user prompts from workflows.json kind/criteria/constraints so workflow meaning lives in data but the arbiter frame stays consistent. Clarify that this is internal prompting, not user prompting.","design":"- Document the canonical 'arbiter frame' prompt: choose one label from allowed set or null; never invent labels; provide brief rationale.\n- For each workflow.kind, define which criteria/constraints fields are surfaced to the LLM.\n- Ensure constraints are expressed as structured text generated from data.\n- Remove existing substring heuristics and any hardcoded expense policy in prompt.\n- Ensure interactive mode is user validation only; end-state non-interactive has no prompts to user.","acceptance_criteria":"- llm-archivist prompt construction is derived from workflow.kind + criteria/constraints, not workflow name.\n- No per-workflow prompt blobs are required.\n- Tests cover at least 2 kinds: expense document and mail_action or reply_draft.","notes":"Agent skim (charlie-agent, 2026-01-04): current llm-archivist LLMAdvisor prompt hardcodes expense behavior via workflow-name substring heuristic (expense/invoice/receipt) and explicitly treats bank transfer/payment notifications as NOT expenses. We confirmed policy: payment confirmations alone =\u003e null unless invoice/receipt present; so the strictness is OK, but it must move to workflow.kind/constraints (no name heuristics) per docs-44x.","status":"open","priority":1,"issue_type":"task","assignee":"bob-agent","created_at":"2026-01-04T10:51:09.093261Z","created_by":"juanre","updated_at":"2026-01-04T12:19:49.691625Z","dependencies":[{"issue_id":"docs-dmc","depends_on_id":"docs-44x","type":"parent-child","created_at":"2026-01-04T12:19:49.692236Z","created_by":"juanre"},{"issue_id":"docs-dmc","depends_on_id":"docs-44x.4","type":"blocks","created_at":"2026-01-04T17:47:31.131172Z","created_by":"juanre"},{"issue_id":"docs-dmc","depends_on_id":"docs-44x.5","type":"blocks","created_at":"2026-01-04T17:47:31.23683Z","created_by":"juanre"}]}
{"id":"docs-e9s","title":"mailflow: drop legacy workflows.json formats/migration","description":"We do not want backwards compatibility or migration code. mailflow currently accepts and migrates legacy workflows.json shapes. End-state: require SOT workflows.json format only and fail fast with a clear error if invalid.","design":"Decision from chat: absolutely no backwards compatibility and no migration/auto-fixup code, even if legacy formats existed previously. We are early and should delete tech debt.\n\nMailflow currently:\n- supports non-SOT workflows.json shapes, and\n- auto-migrates them.\n\nThis must be removed; mailflow should require the current SOT workflows.json schema exactly, and fail fast with a clear error when invalid.","acceptance_criteria":"- mailflow fails fast on non-SOT workflows.json structure (no auto-migration).\n- No legacy-format parsing code remains.\n- Tests pass.","notes":"Superseded by docs-44x.4 (mailflow workflows vNext + handling primitives; includes removal of legacy migration).","status":"closed","priority":2,"issue_type":"chore","assignee":"charlie-agent","created_at":"2026-01-04T09:23:30.083898Z","created_by":"juanre","updated_at":"2026-01-04T17:54:23.981416Z","closed_at":"2026-01-04T17:54:23.981416Z","close_reason":"Superseded by docs-44x.4","dependencies":[{"issue_id":"docs-e9s","depends_on_id":"docs-44x","type":"parent-child","created_at":"2026-01-04T12:19:58.90292Z","created_by":"juanre"}]}
{"id":"docs-ew8","title":"mailflow: remove vendored archive-protocol; depend on docflow-archive","description":"Remove the vendored archive protocol library under mailflow/archive-protocol and make mailflow depend on the standalone docflow-archive repo (package name archive-protocol).","design":"- Delete mailflow/archive-protocol/ and remove it from uv workspace members.\\n- Remove file-classifier-core from mailflow dev deps and uv workspace members (it was only for the legacy gate/training).\\n- Update mailflow/pyproject.toml to source archive-protocol from ../docflow-archive during local dev (package name stays archive-protocol); ensure this is the only archive-protocol source.\\n- Regenerate uv.lock accordingly.\\n- Ensure imports (archive_protocol) still resolve and tests pass.","acceptance_criteria":"- mailflow/archive-protocol/ directory no longer exists.\\n- mailflow/pyproject.toml has no [tool.uv.workspace] member for archive-protocol nor file-classifier-core.\\n- mailflow/pyproject.toml dev deps no longer include file-classifier-core.\\n- mailflow uses ../docflow-archive as the only archive-protocol source.\\n- uv run python -m pytest -q passes.","status":"closed","priority":1,"issue_type":"chore","created_at":"2026-01-02T13:42:30.088547Z","created_by":"juanre","updated_at":"2026-01-02T15:50:53.311354Z","closed_at":"2026-01-02T15:50:53.311354Z","close_reason":"Merged into mailflow main (a584fb1) and removed remaining file-classifier-core dep (bd38f43); vendored archive-protocol deleted; tests: 181 passed.","dependencies":[{"issue_id":"docs-ew8","depends_on_id":"docs-3","type":"discovered-from","created_at":"2026-01-02T13:42:30.089269Z","created_by":"juanre"}]}
{"id":"docs-fda","title":"docflow-cli: add --force to re-run postprocessors and expense extraction","description":"SOT says re-extraction is an explicit operator action. Add a CLI flag (e.g. --force) to: (1) docflow postprocess run and (2) docflow extract expenses, to overwrite an existing owned sidecar block (e.g., accounting.expense). Default remains idempotent skip when block exists. Wire flag through to Postprocessor implementations (e.g., via config dict overwrite=true) and add tests verifying: without --force it skips existing blocks; with --force it rewrites.","status":"closed","priority":2,"issue_type":"feature","assignee":"charlie","created_at":"2026-01-03T13:15:28.756579Z","created_by":"juanre","updated_at":"2026-01-03T13:36:16.521467Z","closed_at":"2026-01-03T13:36:16.521467Z","close_reason":"Merged to docflow main (3238a57); adds --force overwrite","dependencies":[{"issue_id":"docs-fda","depends_on_id":"docs-zq1","type":"discovered-from","created_at":"2026-01-03T13:15:28.758631Z","created_by":"juanre"}]}
{"id":"docs-mba","title":"llm-archivist: remove legacy env vars DATABASE_URL/ARCHIVIST_DB_* (docflow-only config)","description":"We want zero legacy naming/compat. llm-archivist currently documents/uses DATABASE_URL and ARCHIVIST_DB_SCHEMA (and related ARCHIVIST_DB_* in README) and mailflow sets these env vars as a shim. End-state: llm-archivist requires ~/.config/docflow/config.toml [archivist] and/or DOCFLOW_ARCHIVIST_* overrides only; no DATABASE_URL / ARCHIVIST_DB_* in code, docs, or tests.","design":"Decision from chat: we want ZERO legacy naming and ZERO backwards-compat code paths, even if 'we haven't started using this yet'.\n\nTherefore, llm-archivist must not:\n- require/accept DATABASE_URL as a public contract,\n- expose ARCHIVIST_DB_* env vars as a public contract,\n- document those legacy env vars in README.\n\nTarget contract is docflow-only:\n- ~/.config/docflow/config.toml [archivist] is required (fail fast if missing)\n- Optional dev overrides: DOCFLOW_ARCHIVIST_DATABASE_URL, DOCFLOW_ARCHIVIST_DB_SCHEMA, DOCFLOW_ARCHIVIST_SIMILARITY_THRESHOLD only (1:1 to config)\n\nImportant nuance: 'no legacy naming' includes removing any internal shims where connectors set DATABASE_URL/ARCHIVIST_DB_SCHEMA for llm-archivist. Once llm-archivist is config-driven, connectors should pass config (or llm-archivist should read config directly) without env mutation.\n\nThis must be coordinated with all callers (mailflow/slackflow/docflow-cli/gdocsflow) so there is no transitional compat period.","acceptance_criteria":"- No references to DATABASE_URL or ARCHIVIST_DB_*/ARCHIVIST_DB_SCHEMA remain in llm-archivist source, README, or tests.\n- llm-archivist fails fast if ~/.config/docflow/config.toml missing/invalid.\n- Connectors instantiate classifier via config object (no env shims).\n- Full test suite passes.","notes":"Merged/pushed llm-archivist env cleanup (bob-docs-mba@0eaa1d5) into llm-archivist/main; no DATABASE_URL/ARCHIVIST_DB_* remain. Coordinated caller updates: mailflow no longer sets env shims and uses config-based factory (mailflow/main 94b2a65; 195 tests passed).","status":"closed","priority":1,"issue_type":"chore","assignee":"bob-agent","created_at":"2026-01-04T09:23:22.248112Z","created_by":"juanre","updated_at":"2026-01-04T17:12:14.341924Z","closed_at":"2026-01-04T17:12:14.341926Z","dependencies":[{"issue_id":"docs-mba","depends_on_id":"docs-44x","type":"parent-child","created_at":"2026-01-04T12:19:53.971715Z","created_by":"juanre"}]}
{"id":"docs-mba.1","title":"mailflow: remove llm-archivist env shims; require docflow config","description":"Stop exporting DATABASE_URL/ARCHIVIST_DB_SCHEMA from mailflow. mailflow must load ~/.config/docflow/config.toml (or XDG override) and instantiate llm-archivist via its config-based API. Fail fast if archivist db config missing; no legacy env var support.","design":"SOT reference: docflow-sot/source-of-truth/configuration.md and docflow-sot/source-of-truth/classification.md. llm-archivist cannot run without a DB; mailflow must not silently downgrade. End-state contract: no DATABASE_URL / ARCHIVIST_DB_* anywhere. mailflow should not mutate process env to configure llm-archivist; pass config/args directly.","acceptance_criteria":"1) mailflow/src has zero references to DATABASE_URL and ARCHIVIST_DB_*.\n2) mailflow.archivist_client uses llm-archivist config-based factory (e.g., Classifier.from_config_async) and does not set env vars.\n3) CLI/help/docs remove legacy env instructions.\n4) If config missing/invalid, mailflow exits before processing any email and before writing to archive.\n5) All mailflow tests pass.","notes":"Merged bob/mailflow-docs-mba-1 into mailflow/main (94b2a65); removed env shims (no DATABASE_URL/ARCHIVIST_DB_*), mailflow instantiates llm-archivist via config-based API. Ran mailflow tests: 195 passed.","status":"closed","priority":1,"issue_type":"chore","assignee":"bob-agent","created_at":"2026-01-04T13:34:24.203666Z","created_by":"juanre","updated_at":"2026-01-04T17:06:10.068484Z","closed_at":"2026-01-04T17:06:10.068485Z","dependencies":[{"issue_id":"docs-mba.1","depends_on_id":"docs-mba","type":"parent-child","created_at":"2026-01-04T13:34:24.20448Z","created_by":"juanre"}]}
{"id":"docs-zq1","title":"docflow-cli: workflow-driven postprocess runner","description":"Implement workflow-driven post-processing in docflow-cli so domain-specific extractors (expenses, contracts, tax docs, etc.) are pluggable and selected from workflows.json rather than hardcoded in CLI code.","design":"SOT: docflow-sot/source-of-truth/postprocessing.md and configuration.md.\n\n- Add a docflow postprocess command group.\n- Load workflows from ~/.config/docflow/workflows.json (referenced by config.toml) and read each workflow's postprocessors list.\n- Define a small in-process registry mapping postprocessor IDs to implementations.\n  - Postprocessor interface (minimal): id; owned_sidecar_key (e.g. accounting.expense); run_one(content_path, sidecar_path, config) that writes atomically.\n  - Idempotency: default skip when owned block exists; overwrite only with explicit flag.\n- For LLM-based processors: alias-first via bundled llmring.lock + require_aliases() fail-fast.\n- No prompts in non-interactive mode.\n\nCLI behaviors:\n- docflow postprocess run --entity tsm --workflow tsm-expense runs the workflow's declared processors.\n- docflow postprocess run --entity tsm --postprocessor accounting.expense runs one processor across matching docs.\n- --dry-run shows what would change.\n- --limit for safety.\n\nInitial built-in processor:\n- accounting.expense should be wired through this runner (implemented in docs-27).","acceptance_criteria":"- docflow-cli supports docflow postprocess run (entity + workflow selection) and processes only the declared postprocessors.\n- No expense-specific selection logic exists outside the accounting.expense postprocessor.\n- Running on a fixture archive updates sidecars only under owned keys and is idempotent by default.\n- Uses bundled llmring.lock aliases and fails fast if required aliases are missing.","notes":"Required to avoid embedding expense-specific logic in orchestration code and to enable future workflows/postprocessors without refactors.","status":"closed","priority":1,"issue_type":"feature","assignee":"bob","created_at":"2026-01-02T23:15:49.389307Z","created_by":"juanre","updated_at":"2026-01-03T12:08:19.103779Z","closed_at":"2026-01-03T12:08:19.103779Z","close_reason":"Merged to docflow main; postprocess runner + workflow support delivered","dependencies":[{"issue_id":"docs-zq1","depends_on_id":"docs-19","type":"discovered-from","created_at":"2026-01-02T23:15:49.391585Z","created_by":"juanre"}]}

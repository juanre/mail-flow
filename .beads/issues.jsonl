{"id":"mailflow-0lp","title":"Make ui.py select_workflow() async","description":"Convert WorkflowSelector.select_workflow() to async. It calls classify_with_archivist() and record_feedback() which are async. Note: input() is blocking but that's fine - we await the async classifier calls around it.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T18:36:59.126929Z","updated_at":"2025-12-30T19:00:17.994809Z","closed_at":"2025-12-30T19:00:17.994809Z","close_reason":"Completed async refactoring chain. All modules now async with single asyncio.run() at CLI entry points. 235 tests passing.","dependencies":[{"issue_id":"mailflow-0lp","depends_on_id":"mailflow-h5w","type":"discovered-from","created_at":"2025-12-30T18:36:59.127766Z","created_by":"juanre","metadata":"{}"}]}
{"id":"mailflow-14h","title":"Focused training mode for specific workflows","description":"Add ability to train on emails filtered by date range and workflow set, with minimum confidence gate. Enables efficient focused training sessions.","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-30T21:45:38.069429Z","updated_at":"2025-12-30T21:56:14.719931Z","closed_at":"2025-12-30T21:56:14.719931Z","close_reason":"All subtasks complete - focused training mode implemented"}
{"id":"mailflow-1b3","title":"Remove dead code: process.py main() function","description":"The main() function in process.py (lines 246-291) is dead code.\n\nLine 290-291 explicitly states:\n```python\n# CLI is the single entry point. This module is not intended to be executed directly.\n```\n\n**Files to modify:**\n- `process.py:246-291`: DELETE the entire main() function\n\nThe function:\n- Sets up logging\n- Reads email from file or stdin\n- Calls process() directly (not async!)\n- Has its own error handling\n\nThis is superseded by cli.py which properly handles:\n- Click-based CLI with options\n- Async execution via asyncio.run()\n- Proper context passing\n\n**Acceptance criteria:**\n- main() function removed from process.py\n- No __main__ block in process.py\n- CLI remains the only entry point","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-31T17:01:06.68952Z","created_by":"juanre","updated_at":"2025-12-31T17:18:01.093651Z","closed_at":"2025-12-31T17:18:01.093651Z","close_reason":"Removed dead main() function (46 lines) and comment from process.py. CLI is now the only entry point."}
{"id":"mailflow-1sb","title":"Fix failing test_path_traversal_simple_dotdot test","description":"Pre-existing test failure in tests/test_security.py::TestPathValidation::test_path_traversal_simple_dotdot. The test expects PathSecurityError to be raised but it doesn't. This is unrelated to the async refactoring work.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-30T18:37:25.737036Z","updated_at":"2025-12-30T19:33:55.881059Z","closed_at":"2025-12-30T19:33:55.881059Z","close_reason":"Fixed flaky test - made it deterministic by using temp directory as allowed base"}
{"id":"mailflow-2rv","title":"Add --min-confidence gate for focused training","description":"Add --min-confidence option (default 0.0). Run classification before showing to user. Skip emails where best match confidence \u003c threshold. Default 0.45 when --workflows is specified.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T21:45:50.518586Z","updated_at":"2025-12-30T21:56:14.494011Z","closed_at":"2025-12-30T21:56:14.494011Z","close_reason":"Implemented --min-confidence gate (default 0.45 when --workflows set)"}
{"id":"mailflow-2tx","title":"Make archivist_client.py expose async API directly","description":"Remove sync wrappers from archivist_client.py. Expose classify_async(), feedback_async(), get_metrics_async() directly. The current approach of calling asyncio.run() per-call breaks connection pooling because each call creates/destroys an event loop, invalidating the cached connection pool.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T18:36:46.242147Z","updated_at":"2025-12-30T19:00:09.245243Z","closed_at":"2025-12-30T19:00:09.245243Z","close_reason":"Made archivist_client.py expose async API directly. All functions (classify, feedback, get_metrics) are now async. Tests passing."}
{"id":"mailflow-4fg","title":"Send full email context to LLM classification","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-31T10:10:34.428036Z","updated_at":"2025-12-31T10:21:47.904551Z","closed_at":"2025-12-31T10:21:47.904551Z","close_reason":"Implemented full email context for LLM: validation, no truncation, PDF attachment names, HTML→PDF rendering via llmring"}
{"id":"mailflow-86o","title":"Remove duplicate batch command from cli.py","description":"The batch command is defined twice with different implementations:\n\n1. `cli.py:124-290` - Simpler version\n2. `gmail_batch_workflows.py:113-302` - Full version with more options\n\nThe gmail_batch_workflows.py version has features the cli.py version lacks:\n- `--train-only`, `--replay` modes\n- `--after`/`--before` date filtering\n- `--workflows` filter\n- `--min-confidence` gate\n\n**Files to modify:**\n- `cli.py:124-290`: DELETE the entire batch command and _batch_async function\n- `cli.py:513-514`: Keep this registration (it registers the good version)\n- `cli.py:616-617`: Remove duplicate registration of register_gmail_batch(cli)\n\n**Also duplicated:**\n- `cli.py:16-17`: Double import of register functions (index_search and gmail_batch)\n- Line 513-514 imports and calls _register_gbw\n- Line 616-617 calls register_gmail_batch again\n\n**Acceptance criteria:**\n- Only one batch command exists (from gmail_batch_workflows.py)\n- No duplicate command registrations\n- All batch features available (train-only, replay, date filtering, etc.)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T17:01:06.462712Z","created_by":"juanre","updated_at":"2025-12-31T17:17:14.843332Z","closed_at":"2025-12-31T17:17:14.843332Z","close_reason":"Removed duplicate batch command and _batch_async from cli.py (177 lines). Removed duplicate _register_gbw import and call. Removed unused ProcessedEmailsTracker import. Now only one batch command exists (from gmail_batch_workflows.py)"}
{"id":"mailflow-8ei","title":"Update tests for async refactoring","description":"Update tests that call process(), select_workflow(), or archivist functions to be async. pytest-asyncio is already configured (asyncio_mode = auto). Tests need to use async def and await the async functions.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T18:37:18.544966Z","updated_at":"2025-12-30T19:00:17.99548Z","closed_at":"2025-12-30T19:00:17.99548Z","close_reason":"Completed async refactoring chain. All modules now async with single asyncio.run() at CLI entry points. 235 tests passing.","dependencies":[{"issue_id":"mailflow-8ei","depends_on_id":"mailflow-oc7","type":"discovered-from","created_at":"2025-12-30T18:37:18.545778Z","created_by":"juanre","metadata":"{}"}]}
{"id":"mailflow-9oi","title":"Make process.py process() async","description":"Convert process() function to async. It calls ui.select_workflow() which is async. This is the main processing function that orchestrates email classification and workflow execution.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T18:37:04.737914Z","updated_at":"2025-12-30T19:00:17.995046Z","closed_at":"2025-12-30T19:00:17.995046Z","close_reason":"Completed async refactoring chain. All modules now async with single asyncio.run() at CLI entry points. 235 tests passing.","dependencies":[{"issue_id":"mailflow-9oi","depends_on_id":"mailflow-0lp","type":"discovered-from","created_at":"2025-12-30T18:37:04.73878Z","created_by":"juanre","metadata":"{}"}]}
{"id":"mailflow-9pp","title":"Remove stale config options for optional LLM/DB","description":"After removing optional LLM and database fallbacks, clean up the config options that are no longer meaningful.\n\n**Config options to REMOVE from config.py _default_settings():**\n- `llm.enabled` (line 168) - LLM is always required\n- `llm.fallback_to_similarity` (line 171) - No fallbacks allowed\n- `classifier.enabled` (line 181) - Archivist is always required\n\n**Config options to KEEP:**\n- `llm.model_alias` - Still needed to select fast/balanced/deep\n- `classifier.gate_enabled` - Worth-archiving gate (separate from LLM requirement)\n- `classifier.gate_min_confidence` - Gate threshold\n\n**Files to modify:**\n- `config.py:167-184`: Remove stale options from _default_settings()\n- `config.py:203-214`: Remove validation of removed options\n- Any code that reads these removed options (will be caught by other beads)\n\n**Acceptance criteria:**\n- Config schema reflects actual required behavior\n- No config options that suggest LLM/DB are optional\n- Existing user configs with removed options don't break (ignore unknown keys)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T17:01:29.819808Z","created_by":"juanre","updated_at":"2025-12-31T17:24:21.450156Z","closed_at":"2025-12-31T17:24:21.450156Z","close_reason":"Verified config.py is clean (llm.enabled, llm.fallback_to_similarity, classifier.enabled already removed). Fixed stale init instructions in cli.py to reflect LLM/DB requirements","dependencies":[{"issue_id":"mailflow-9pp","depends_on_id":"mailflow-a59","type":"blocks","created_at":"2025-12-31T17:01:40.600826Z","created_by":"juanre"},{"issue_id":"mailflow-9pp","depends_on_id":"mailflow-kly","type":"blocks","created_at":"2025-12-31T17:01:40.693728Z","created_by":"juanre"}]}
{"id":"mailflow-a59","title":"Remove LLM optional flags and --no-llm CLI option","description":"LLM classification via llm-archivist must be unconditionally required. Currently it can be disabled at multiple levels:\n\n**Files to modify:**\n- `config.py:167-171`: Remove `llm.enabled` config option entirely\n- `config.py:171`: Remove `llm.fallback_to_similarity` option\n- `cli.py:30-31`: Remove `--llm/--no-llm` flag from main CLI group\n- `cli.py:116-117`: Remove `--llm/--no-llm` from batch command\n- `gmail_batch_workflows.py:101-102`, `307-308`: Remove `--llm/--no-llm` from fetch files\n- `process.py:27`: Remove `llm_enabled: bool | None = None` parameter\n- `process.py:57-61`: Remove the override logic for llm_enabled\n\n**Acceptance criteria:**\n- No way to disable LLM from config or CLI\n- All classification flows require LLM\n- Tests updated to not use --no-llm flags","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-31T17:00:21.253606Z","created_by":"juanre","updated_at":"2025-12-31T17:08:53.20451Z","closed_at":"2025-12-31T17:08:53.20451Z","close_reason":"Removed LLM optional flags from config.py, cli.py, process.py, and gmail_batch_workflows.py. Note: duplicate batch command in cli.py still has --llm/--no-llm but will be deleted entirely in mailflow-86o"}
{"id":"mailflow-c9i","title":"Sort emails by date descending (most recent first)","description":"Always sort emails by Date header descending (most recent first) in batch processing. Keep email_files, email_contents, email_data_list in sync during sort. This is the default behavior, not optional.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T21:45:50.279973Z","updated_at":"2025-12-30T21:50:13.264046Z","closed_at":"2025-12-30T21:50:13.264046Z","close_reason":"Implemented date sorting - emails now processed most recent first"}
{"id":"mailflow-cii","title":"Remove direct llmring classification - use only llm-archivist","description":"The codebase has two parallel LLM classification systems. llm-archivist is canonical; the direct llmring path should be removed.\n\n**Files to DELETE entirely:**\n- `llm_classifier.py` - Direct llmring calls with custom prompt (251 lines)\n- `hybrid_classifier.py` - Routes between similarity and direct LLM (141 lines)\n\n**Files to modify:**\n- `process.py:12-13`: Remove imports of HybridClassifier, LLMClassifier\n- `process.py:67-82`: Remove hybrid_classifier setup entirely\n- `ui.py:19`: Constructor takes hybrid_classifier param - remove it\n- `ui.py:23`: Remove self.hybrid_classifier attribute\n- `ui.py:67-78`: Remove fallback to hybrid_classifier\n- `cli.py:143-173`: Remove hybrid_classifier setup in _batch_async\n- `gmail_batch_workflows.py:121-173`: Remove hybrid_classifier setup\n\n**Architecture after this change:**\n- Only classification path: ui.py → archivist_integration.py → archivist_client.py → llm-archivist\n- Similarity engine used ONLY as a pre-filter gate (separate bead)\n\n**Acceptance criteria:**\n- No direct llmring usage in mailflow\n- All classification goes through llm-archivist\n- llm_classifier.py and hybrid_classifier.py deleted","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-31T17:01:06.229752Z","created_by":"juanre","updated_at":"2025-12-31T17:22:43.695411Z","closed_at":"2025-12-31T17:22:43.695411Z","close_reason":"Deleted llm_classifier.py (251 lines) and hybrid_classifier.py (141 lines). Removed all references from process.py, ui.py, and gmail_batch_workflows.py. Only classification path now: ui.py → archivist_integration.py → llm-archivist","dependencies":[{"issue_id":"mailflow-cii","depends_on_id":"mailflow-a59","type":"blocks","created_at":"2025-12-31T17:01:40.414786Z","created_by":"juanre"}]}
{"id":"mailflow-h5w","title":"Make archivist_integration.py async","description":"Convert classify_with_archivist() and record_feedback() to async functions. These call archivist_client which needs to be async for proper connection pool management.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T18:36:52.371522Z","updated_at":"2025-12-30T19:00:17.994283Z","closed_at":"2025-12-30T19:00:17.994283Z","close_reason":"Completed async refactoring chain. All modules now async with single asyncio.run() at CLI entry points. 235 tests passing.","dependencies":[{"issue_id":"mailflow-h5w","depends_on_id":"mailflow-2tx","type":"discovered-from","created_at":"2025-12-30T18:36:52.372926Z","created_by":"juanre","metadata":"{}"}]}
{"id":"mailflow-kly","title":"Remove database fallbacks - fail hard if DATABASE_URL missing","description":"The archivist_client.py correctly raises RuntimeError if DATABASE_URL is not set, but every call site catches and falls back to non-database operation.\n\n**Files to modify:**\n- `ui.py:50-65`: Remove try/except around classify_with_archivist - let it fail\n- `ui.py:67-83`: Remove fallback to hybrid_classifier and similarity_engine\n- `process.py:78-80`: Remove fallback when LLM init fails\n- `config.py:180-184`: Remove `classifier.enabled` option (archivist is always required)\n\n**Current fallback chain in ui.py:49-83:**\n```\n1. Try archivist classifier → if fails...\n2. Try hybrid_classifier → if fails...\n3. Fall back to pure similarity engine\n```\n\n**Target behavior:**\n- If DATABASE_URL not set, fail immediately with clear error message\n- If archivist classification fails, fail with error (don't silently degrade)\n\n**Acceptance criteria:**\n- No silent fallbacks to non-database operation\n- Clear error messages when database unavailable\n- Tests verify failure behavior","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-31T17:00:43.554574Z","created_by":"juanre","updated_at":"2025-12-31T17:12:51.520148Z","closed_at":"2025-12-31T17:12:51.520148Z","close_reason":"Removed database fallbacks from ui.py - archivist is now always required. Removed classifier.enabled config option. Updated workflow.py to always run file-classifier (not conditional on enabled). Note: hybrid_classifier references in ui.py will be cleaned up in mailflow-cii"}
{"id":"mailflow-lss","title":"Add --workflows filter to batch/fetch files","description":"Add --workflows/-w option accepting comma-separated workflow names. Pass filtered workflow list to classifier. Only show these workflows as options.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T21:45:49.815871Z","updated_at":"2025-12-30T21:56:14.278733Z","closed_at":"2025-12-30T21:56:14.278733Z","close_reason":"Implemented --workflows filter option"}
{"id":"mailflow-oc7","title":"Update CLI entry points to use asyncio.run() once at top level","description":"Refactor CLI commands (batch, gmail, archivist-metrics, single email processing) to use a single asyncio.run() at the entry point. This keeps the event loop alive for the entire operation, allowing the connection pool to be reused properly. Pattern: sync CLI function calls asyncio.run(async_impl(...)).","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T18:37:12.086351Z","updated_at":"2025-12-30T19:00:17.995274Z","closed_at":"2025-12-30T19:00:17.995274Z","close_reason":"Completed async refactoring chain. All modules now async with single asyncio.run() at CLI entry points. 235 tests passing.","dependencies":[{"issue_id":"mailflow-oc7","depends_on_id":"mailflow-9oi","type":"discovered-from","created_at":"2025-12-30T18:37:12.087193Z","created_by":"juanre","metadata":"{}"}]}
{"id":"mailflow-pf6","title":"Add date range filtering (--after, --before)","description":"Add --after and --before options (YYYY-MM-DD format) to batch/fetch files. Parse email Date headers during pre-extraction. Filter emails outside the range. Works independently of --workflows.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T21:45:50.048194Z","updated_at":"2025-12-30T21:52:20.4306Z","closed_at":"2025-12-30T21:52:20.4306Z","close_reason":"Implemented --after and --before date filtering options"}
{"id":"mailflow-rm6","title":"Clarify similarity engine role as pre-LLM gate","description":"The similarity engine should serve as a pre-filter gate for LLM classification, not an alternative to it.\n\n**Current behavior (hybrid_classifier.py):**\n- HIGH_CONFIDENCE (≥0.85): Skip LLM entirely, use similarity only\n- MEDIUM_CONFIDENCE (0.50-0.85): Show both similarity and LLM suggestions  \n- LOW_CONFIDENCE (\u003c0.50): Use LLM as primary\n\n**Target behavior:**\n- Below threshold (e.g., 50-60%): Skip email entirely (not worth classifying)\n- Above threshold: Always send to LLM (llm-archivist)\n- Very high similarity (≥98%?): Consider skipping LLM (cost optimization) - needs discussion\n\n**This is partially implemented:**\n- `ui.py:102-106`: `_min_confidence` gate skips emails below threshold\n- `gmail_batch_workflows.py:140-141`: Default min_confidence=0.45 when --workflows set\n\n**Files to modify:**\n- `similarity.py`: Keep as-is, but document its role as pre-filter\n- `ui.py`: Make the min_confidence gate the ONLY way similarity affects flow\n- Remove the HIGH_CONFIDENCE \"skip LLM\" path (or make it configurable with very high threshold like 98%)\n\n**Design decisions needed:**\n1. What should the default min_confidence gate be? (Currently 0.45 only when --workflows set)\n2. Should there be a \"very high confidence skip LLM\" optimization? At what threshold?\n3. Should these thresholds be configurable?\n\n**Acceptance criteria:**\n- Clear documentation of similarity engine's role\n- Consistent gate behavior across all entry points\n- No silent skipping of LLM for \"high confidence\" similarity matches (unless explicitly configured)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-31T17:01:29.585292Z","created_by":"juanre","updated_at":"2025-12-31T17:30:50.327733Z","closed_at":"2025-12-31T17:30:50.327733Z","close_reason":"Implemented similarity as pre-LLM gate: min_threshold (skip below), skip_llm_threshold (accept above), min_training_examples before gate activates","dependencies":[{"issue_id":"mailflow-rm6","depends_on_id":"mailflow-cii","type":"blocks","created_at":"2025-12-31T17:01:40.507273Z","created_by":"juanre"}]}
